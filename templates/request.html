<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>asong.live</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  :root {
    --black:#0a0a0a; --white:#f5f5f0; --gray-100:#f0f0eb;
    --gray-200:#e0e0d8; --gray-400:#999990; --gray-600:#555550;
    --orange:#FF6B2B; --orange-dim:rgba(255,107,43,0.1);
    --green:#1a6b3a; --green-light:#e8f5ee;
    --red:#8b1a1a; --red-light:#fceaea;
  }
  body { background:var(--white); color:var(--black); font-family:'DM Sans',sans-serif; min-height:100vh; }

  .header { background:var(--black); padding:14px 20px; position:sticky; top:0; z-index:100; }
  .header-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .logo { display:flex; align-items:center; gap:10px; }
  .logo-text { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:2px; color:var(--white); line-height:1; }
  .logo-text span { color:var(--orange); }
  .lang-toggle { display:flex; gap:2px; background:#1a1a1a; border-radius:4px; padding:3px; }
  .lang-btn { padding:4px 10px; border-radius:2px; font-size:0.7rem; font-weight:700; letter-spacing:1px; border:none; cursor:pointer; transition:all .2s; background:transparent; color:var(--gray-400); }
  .lang-btn.active { background:var(--white); color:var(--black); }
  .event-name { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:2px; color:var(--white); line-height:1; }
  .event-sub { color:var(--gray-400); font-size:0.65rem; letter-spacing:2px; text-transform:uppercase; margin-top:2px; display:none; }

  .main { padding:20px; display:flex; flex-direction:column; gap:20px; }

  .section-label { font-size:0.62rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-400); margin-bottom:10px; }

  /* SEARCH */
  .search-wrap { position:relative; }
  .search-input { width:100%; background:var(--white); border:2px solid var(--gray-400); border-radius:3px; padding:14px 44px 14px 16px; font-family:'DM Sans',sans-serif; font-size:0.95rem; color:var(--black); outline:none; transition:border .2s; }
  .search-input:focus { border-color:var(--black); }
  .search-input::placeholder { color:var(--gray-400); }
  .search-icon { position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--gray-400); }
  .spinner { text-align:center; padding:16px; color:var(--gray-400); font-size:0.75rem; letter-spacing:2px; text-transform:uppercase; display:none; }

  /* TRACK CARDS */
  .track-card { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:3px; border:1.5px solid var(--gray-200); margin-bottom:8px; cursor:pointer; transition:all .2s; background:var(--white); }
  .track-card:active { background:var(--gray-100); }
  .track-card.selected { border-color:var(--black); background:var(--gray-100); }
  .track-img { width:48px; height:48px; border-radius:2px; object-fit:cover; flex-shrink:0; }
  .track-name { font-weight:700; font-size:0.88rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .track-artist { color:var(--gray-600); font-size:0.75rem; margin-top:2px; }
  .track-check { margin-left:auto; width:24px; height:24px; border-radius:50%; border:2px solid var(--gray-200); flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all .2s; font-size:0.7rem; font-weight:700; }
  .track-card.selected .track-check { background:var(--black); border-color:var(--black); color:var(--white); }

  /* SELECTED */
  .selected-section { display:none; }
  .selected-section.visible { display:block; }
  .selected-card { display:flex; gap:14px; align-items:center; background:var(--black); border-radius:4px; padding:14px; margin-bottom:14px; }
  .selected-img { width:64px; height:64px; border-radius:3px; object-fit:cover; flex-shrink:0; }
  .selected-label { font-size:0.6rem; letter-spacing:2px; text-transform:uppercase; color:var(--orange); margin-bottom:4px; }
  .selected-name { font-weight:700; font-size:1rem; color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .selected-artist { color:var(--gray-400); font-size:0.75rem; margin-top:2px; }
  .btn-clear { background:transparent; border:none; color:var(--gray-400); font-size:1.2rem; cursor:pointer; padding:4px; flex-shrink:0; }

  .dedic-input { width:100%; background:var(--gray-100); border:2px solid var(--gray-200); border-radius:3px; padding:12px 14px; font-family:'DM Sans',sans-serif; font-size:0.88rem; color:var(--black); outline:none; resize:none; transition:border .2s; }
  .dedic-input:focus { border-color:var(--black); background:var(--white); }
  .char-count { text-align:right; font-size:0.65rem; color:var(--gray-400); margin-top:4px; margin-bottom:12px; }

  .btn-submit { width:100%; padding:16px; background:var(--orange); color:var(--white); border:none; border-radius:3px; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:700; letter-spacing:3px; text-transform:uppercase; cursor:pointer; transition:opacity .2s; }
  .btn-submit:disabled { opacity:0.4; cursor:not-allowed; }

  /* CONFIRM CARD */
  .confirm-card { display:none; background:var(--black); border-radius:6px; padding:20px; text-align:center; }
  .confirm-card.visible { display:block; }
  .confirm-img { width:80px; height:80px; border-radius:4px; object-fit:cover; margin:0 auto 12px; display:block; }
  .confirm-title { font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; color:var(--orange); margin-bottom:4px; }
  .confirm-song { font-weight:700; font-size:1rem; color:var(--white); margin-bottom:2px; }
  .confirm-artist { font-size:0.75rem; color:var(--gray-400); margin-bottom:12px; }
  .confirm-status { font-size:0.7rem; letter-spacing:2px; text-transform:uppercase; color:var(--gray-400); }
  .confirm-status.approved { color:#4CAF50; }
  .confirm-status.next { color:var(--orange); }

  /* DIVIDER */
  .divider { height:1px; background:var(--gray-200); }

  /* QUEUE */
  .queue-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .queue-count { background:var(--orange); color:var(--white); border-radius:20px; padding:2px 10px; font-size:0.7rem; font-weight:700; }

  .queue-item { display:flex; gap:12px; align-items:center; padding:12px; background:var(--white); border:1.5px solid var(--gray-200); border-radius:3px; margin-bottom:8px; }
  .queue-item.my-song { border-color:var(--orange); background:var(--orange-dim); }
  .queue-img { width:48px; height:48px; border-radius:2px; object-fit:cover; flex-shrink:0; }
  .queue-name { font-weight:700; font-size:0.88rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .queue-artist { color:var(--gray-600); font-size:0.75rem; margin-top:2px; }
  .queue-dedic { color:var(--gray-400); font-size:0.7rem; margin-top:3px; font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .queue-meta { display:flex; align-items:center; gap:6px; margin-top:4px; flex-wrap:wrap; }
  .status-pill { font-size:0.58rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; padding:2px 8px; border-radius:20px; }
  .status-pendiente { background:var(--gray-100); color:var(--gray-400); }
  .status-aprobada { background:var(--green-light); color:var(--green); }
  .my-tag { font-size:0.58rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; padding:2px 8px; border-radius:20px; background:var(--orange-dim); color:var(--orange); border:1px solid var(--orange); }

  .vote-btn { background:var(--gray-100); border:1.5px solid var(--gray-200); border-radius:3px; padding:6px 10px; font-size:0.75rem; font-weight:700; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:1px; transition:all .2s; min-width:44px; flex-shrink:0; }
  .vote-btn.voted { border-color:var(--orange); background:var(--orange); color:var(--white); }

  .empty { text-align:center; padding:32px 20px; color:var(--gray-400); }
  .empty-icon { font-size:2rem; margin-bottom:8px; }
  .empty-text { font-size:0.75rem; letter-spacing:2px; text-transform:uppercase; }

  /* NOTIFICATIONS */
  .dj-notif { position:fixed; top:0; left:0; right:0; z-index:200; padding:16px 20px; text-align:center; font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; transform:translateY(-100%); transition:transform .4s cubic-bezier(.175,.885,.32,1.275); }
  .dj-notif.show { transform:translateY(0); }
  .dj-notif.approved { background:var(--green); color:#fff; }
  .dj-notif.rejected { background:var(--red); color:#fff; }
  .dj-notif.reproducida { background:var(--black); color:#fff; }
  .dj-notif.next_song { background:var(--orange); color:#fff; }

  .toast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--black); color:var(--white); padding:12px 24px; border-radius:3px; font-size:0.8rem; font-weight:600; letter-spacing:1px; transition:transform .3s; z-index:999; white-space:nowrap; max-width:90vw; text-align:center; }
  .toast.error { background:var(--red); }
  .toast.show { transform:translateX(-50%) translateY(0); }

  .retry-modal { position:fixed; bottom:0; left:0; right:0; z-index:300; background:var(--white); border-top:2px solid var(--black); padding:24px 20px; transform:translateY(100%); transition:transform .4s cubic-bezier(.175,.885,.32,1.275); }
  .retry-modal.show { transform:translateY(0); }
  .retry-icon { font-size:2rem; text-align:center; margin-bottom:8px; }
  .retry-title { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:2px; text-align:center; margin-bottom:6px; }
  .retry-sub { color:var(--gray-600); font-size:0.82rem; text-align:center; margin-bottom:20px; line-height:1.5; }
  .btn-retry { width:100%; padding:15px; background:var(--black); color:var(--white); border:none; border-radius:3px; font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; cursor:pointer; margin-bottom:10px; }
  .btn-retry.secondary { background:transparent; color:var(--gray-400); border:1.5px solid var(--gray-200); }
</style>
</head>
<body>

<div class="dj-notif" id="djNotif"></div>

<div class="header">
  <div class="header-top">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 60" width="18" height="28">
        <rect x="0" y="15" width="5" height="30" fill="#FF6B2B" rx="2" opacity="0.4"/>
        <rect x="9" y="8" width="5" height="44" fill="#FF6B2B" rx="2" opacity="0.7"/>
        <rect x="18" y="0" width="5" height="60" fill="#FF6B2B" rx="2"/>
        <rect x="27" y="10" width="5" height="40" fill="#FF6B2B" rx="2" opacity="0.7"/>
        <rect x="36" y="20" width="5" height="20" fill="#FF6B2B" rx="2" opacity="0.4"/>
      </svg>
      <div class="logo-text">asong<span>.live</span></div>
    </div>
    <div class="lang-toggle">
      <button class="lang-btn active" onclick="setLang('en')" id="btnEn">EN</button>
      <button class="lang-btn" onclick="setLang('es')" id="btnEs">ES</button>
    </div>
  </div>
  <div class="event-name" id="eventName" style="padding-left:20px">DJ Request</div><div style="font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--gray-400);margin-top:3px;padding-left:48px">asong.live</div>
  <div class="event-sub" id="eventSub">Request your song</div>
</div>

<div class="main">

  <!-- CONFIRM CARD -->
  <div class="confirm-card" id="confirmCard">
    <img class="confirm-img" id="confirmImg" src="" alt="">
    <div class="confirm-title" id="confirmTitle">üéµ Request Sent!</div>
    <div class="confirm-song" id="confirmSong"></div>
    <div class="confirm-artist" id="confirmArtist"></div>
    <div class="confirm-status" id="confirmStatus">Waiting for DJ approval...</div>
  </div>

  <!-- SEARCH -->
  <div>
    <div class="section-label" id="searchLabel">Search by song or artist</div>
    <div class="search-wrap">
      <input class="search-input" id="searchInput" type="text" placeholder="Search..." oninput="onSearch(this.value)" autocomplete="off">
      <span class="search-icon">‚ô™</span>
    </div>
    <div class="spinner" id="spinner">Searching...</div>
    <div id="results"></div>
  </div>

  <!-- SELECTED -->
  <div class="selected-section" id="selectedSection">
    <div class="selected-card">
      <img class="selected-img" id="selectedImg" src="" alt="">
      <div style="flex:1;min-width:0">
        <div class="selected-label" id="selectedLabel">Selected</div>
        <div class="selected-name" id="selectedName"></div>
        <div class="selected-artist" id="selectedArtist"></div>
      </div>
      <button class="btn-clear" onclick="clearSelection()">‚úï</button>
    </div>
    <div class="section-label" id="dedicLabel">Message for the DJ (optional)</div>
    <textarea class="dedic-input" id="dedicatoria" rows="2" maxlength="200" oninput="document.getElementById('charCount').textContent=this.value.length" placeholder="Dedicate this song..."></textarea>
    <div class="char-count"><span id="charCount">0</span>/200</div>
    <button class="btn-submit" id="submitBtn" onclick="enviarSolicitud()">
      <span id="submitText">Send Request</span>
    </button>
  </div>

  <!-- DIVIDER -->
  <div class="divider"></div>

  <!-- QUEUE -->
  <div>
    <div class="queue-header">
      <div class="section-label" style="margin-bottom:0" id="queueLabel">Song Queue</div>
      <div class="queue-count" id="queueCount" style="display:none">0</div>
    </div>
    <div id="queueContainer">
      <div class="empty"><div class="empty-icon">üéµ</div><div class="empty-text" id="emptyText">No requests yet</div></div>
    </div>
  </div>

</div>

<div class="retry-modal" id="retryModal">
  <div class="retry-icon">üòî</div>
  <div class="retry-title" id="retryTitle">Not available right now</div>
  <div class="retry-sub" id="retrySub">The DJ doesn't have that one tonight, but the night is young!</div>
  <button class="btn-retry" id="retryBtn" onclick="retryRequest()">üéµ Try Another Song</button>
  <button class="btn-retry secondary" id="laterBtn" onclick="closeRetry()">Maybe Later</button>
</div>
<div class="toast" id="toast"></div>

<script>
const EVENTO_ID = {{ evento.id if evento else 1 }};
let selectedTrack = null;
let searchTimer = null;
let votados = JSON.parse(localStorage.getItem('votados') || '[]');
let mySongId = null;
let lang = navigator.language.startsWith('es') ? 'es' : 'en';
let solicitudWS = null;
let lastQueueHash = '';

const t = {
  en: {
    searchLabel:'Search by song or artist', searchPlaceholder:'Search...', searching:'Searching...',
    selectedLabel:'Selected', dedicLabel:'Message for the DJ (optional)', dedicPlaceholder:'Dedicate this song...',
    submitText:'Send Request', sending:'Sending...', queueLabel:'Song Queue',
    noRequests:'No requests yet', eventSub:'Request your song',
    confirmTitle:'üéµ Request Sent!', waitingApproval:'Waiting for DJ approval...',
    approved:'‚úÖ DJ has your song! Coming soon üé∂', next:'‚ö° Get ready! YOUR song is NEXT! üî•',
    retryTitle:'Not available right now', retrySub:"The DJ doesn't have that one tonight, but the night is young!",
    retryBtn:'üéµ Try Another Song', laterBtn:'Maybe Later',
    toastSent:'‚úÖ Request sent!', toastVoted:'üî• Vote registered!', toastAlready:'Already voted!',
    notifApproved:'‚úÖ Your song is in the queue! üé∂', notifNext:'‚ö° Get ready! Your song is NEXT üî•',
    notifPlaying:'üéâ Your song is playing NOW!', yourSong:'Your song', noResults:'No results'
  },
  es: {
    searchLabel:'Busca por canci√≥n o artista', searchPlaceholder:'Buscar...', searching:'Buscando...',
    selectedLabel:'Seleccionada', dedicLabel:'Mensaje para el DJ (opcional)', dedicPlaceholder:'Dedica esta canci√≥n...',
    submitText:'Enviar Solicitud', sending:'Enviando...', queueLabel:'Cola de Canciones',
    noRequests:'Sin solicitudes a√∫n', eventSub:'Pide tu canci√≥n',
    confirmTitle:'üéµ ¬°Solicitud Enviada!', waitingApproval:'Esperando aprobaci√≥n del DJ...',
    approved:'‚úÖ ¬°El DJ tiene tu canci√≥n! Viene pronto üé∂', next:'‚ö° ¬°Prep√°rate! Tu canci√≥n es la SIGUIENTE üî•',
    retryTitle:'No disponible ahorita', retrySub:'El DJ no la tiene esta noche, ¬°pero la noche es larga!',
    retryBtn:'üéµ Pide Otra Canci√≥n', laterBtn:'Quiz√°s despu√©s',
    toastSent:'‚úÖ ¬°Solicitud enviada!', toastVoted:'üî• ¬°Voto registrado!', toastAlready:'¬°Ya votaste!',
    notifApproved:'‚úÖ ¬°Tu canci√≥n est√° en la cola! üé∂', notifNext:'‚ö° ¬°Prep√°rate! Tu canci√≥n es la SIGUIENTE üî•',
    notifPlaying:'üéâ ¬°Tu canci√≥n suena AHORA!', yourSong:'Tu canci√≥n', noResults:'Sin resultados'
  }
};

function setLang(l) {
  lang = l;
  document.getElementById('btnEn').classList.toggle('active', l==='en');
  document.getElementById('btnEs').classList.toggle('active', l==='es');
  const s = t[l];
  document.getElementById('searchLabel').textContent = s.searchLabel;
  document.getElementById('searchInput').placeholder = s.searchPlaceholder;
  document.getElementById('spinner').textContent = s.searching;
  document.getElementById('selectedLabel').textContent = s.selectedLabel;
  document.getElementById('dedicLabel').textContent = s.dedicLabel;
  document.getElementById('dedicatoria').placeholder = s.dedicPlaceholder;
  document.getElementById('submitText').textContent = s.submitText;
  document.getElementById('queueLabel').textContent = s.queueLabel;
  document.getElementById('emptyText').textContent = s.noRequests;
  document.getElementById('eventSub').textContent = s.eventSub;
  document.getElementById('retryTitle').textContent = s.retryTitle;
  document.getElementById('retrySub').textContent = s.retrySub;
  document.getElementById('retryBtn').textContent = s.retryBtn;
  document.getElementById('laterBtn').textContent = s.laterBtn;
}

fetch('/api/config/publica').then(r=>r.json()).then(cfg=>{
  if(cfg.event_name) document.getElementById('eventName').textContent = cfg.event_name;
  if(cfg.subtitle) document.getElementById('eventSub').textContent = cfg.subtitle;
}).catch(()=>{});

setLang(lang);

function onSearch(q) {
  clearTimeout(searchTimer);
  if (q.length < 2) { document.getElementById('results').innerHTML=''; return; }
  document.getElementById('spinner').style.display = 'block';
  searchTimer = setTimeout(() => buscar(q), 500);
}

async function buscar(q) {
  const res = await fetch('/api/buscar?q='+encodeURIComponent(q));
  const tracks = await res.json();
  document.getElementById('spinner').style.display = 'none';
  const c = document.getElementById('results');
  if (!tracks.length) {
    c.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">${t[lang].noResults}</div></div>`;
    return;
  }
  c.innerHTML = tracks.map(tk => `
    <div class="track-card" onclick="selectTrack(${JSON.stringify(tk).replace(/"/g,'&quot;')})" data-id="${tk.spotify_id}">
      <img class="track-img" src="${tk.portada_url}" alt="" onerror="this.style.display='none'">
      <div style="flex:1;min-width:0">
        <div class="track-name">${tk.cancion}</div>
        <div class="track-artist">${tk.artista}</div>
      </div>
      <div class="track-check"></div>
    </div>`).join('');
}

function selectTrack(track) {
  selectedTrack = track;
  document.querySelectorAll('.track-card').forEach(c => { c.classList.remove('selected'); c.querySelector('.track-check').textContent=''; });
  const card = document.querySelector(`[data-id="${track.spotify_id}"]`);
  if (card) { card.classList.add('selected'); card.querySelector('.track-check').textContent='‚úì'; }
  document.getElementById('selectedImg').src = track.portada_url;
  document.getElementById('selectedName').textContent = track.cancion;
  document.getElementById('selectedArtist').textContent = track.artista;
  document.getElementById('selectedSection').classList.add('visible');
  document.getElementById('selectedSection').scrollIntoView({behavior:'smooth', block:'nearest'});
}

function clearSelection() {
  selectedTrack = null;
  document.getElementById('selectedSection').classList.remove('visible');
  document.querySelectorAll('.track-card').forEach(c => { c.classList.remove('selected'); c.querySelector('.track-check').textContent=''; });
}

async function enviarSolicitud() {
  if (!selectedTrack) return;
  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  document.getElementById('submitText').textContent = t[lang].sending;

  const res = await fetch('/api/solicitar', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ evento_id:EVENTO_ID, cancion:selectedTrack.cancion, artista:selectedTrack.artista, spotify_id:selectedTrack.spotify_id, portada_url:selectedTrack.portada_url, dedicatoria:document.getElementById('dedicatoria').value })
  });
  const data = await res.json();

  if (res.ok) {
    mySongId = data.id;
    document.getElementById('confirmImg').src = selectedTrack.portada_url;
    document.getElementById('confirmSong').textContent = selectedTrack.cancion;
    document.getElementById('confirmArtist').textContent = selectedTrack.artista;
    document.getElementById('confirmTitle').textContent = t[lang].confirmTitle;
    document.getElementById('confirmStatus').textContent = t[lang].waitingApproval;
    document.getElementById('confirmStatus').className = 'confirm-status';
    document.getElementById('confirmCard').classList.add('visible');
    conectarWS(data.id);
    document.getElementById('searchInput').value = '';
    document.getElementById('results').innerHTML = '';
    document.getElementById('selectedSection').classList.remove('visible');
    document.getElementById('dedicatoria').value = '';
    document.getElementById('charCount').textContent = '0';
    selectedTrack = null;
    loadQueue();
    showToast(t[lang].toastSent);
    window.scrollTo({top:0, behavior:'smooth'});
  } else {
    showToast(data.detail || 'Error', true);
  }

  btn.disabled = false;
  document.getElementById('submitText').textContent = t[lang].submitText;
}

function conectarWS(solicitudId) {
  if (solicitudWS) solicitudWS.close();
  const protocol = location.protocol==='https:' ? 'wss:' : 'ws:';
  solicitudWS = new WebSocket(protocol+'//'+location.host+'/ws/usuario/'+solicitudId);
  solicitudWS.onclose = () => { setTimeout(() => { if(mySongId===solicitudId) conectarWS(solicitudId); }, 3000); };
  solicitudWS.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const statusEl = document.getElementById('confirmStatus');
    if (msg.tipo === 'rechazada') {
      document.getElementById('confirmCard').classList.remove('visible');
      mySongId = null;
      showRetryModal();
    } else if (msg.tipo === 'aprobada') {
      if(statusEl){ statusEl.textContent=t[lang].approved; statusEl.className='confirm-status approved'; }
      showDJNotif(t[lang].notifApproved, 'approved');
    } else if (msg.tipo === 'next_song') {
      if(statusEl){ statusEl.textContent=t[lang].next; statusEl.className='confirm-status next'; }
      showDJNotif(t[lang].notifNext, 'next_song', 8000);
    } else if (msg.tipo === 'reproducida') {
      document.getElementById('confirmCard').classList.remove('visible');
      mySongId = null;
      showDJNotif(t[lang].notifPlaying, 'reproducida', 6000);
    }
    loadQueue();
  };
}

function showDJNotif(msg, type, duration=5000) {
  const n = document.getElementById('djNotif');
  n.textContent = msg;
  n.className = 'dj-notif show ' + type;
  setTimeout(() => n.classList.remove('show'), duration);
}

function showToast(msg, isError=false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show' + (isError?' error':'');
  setTimeout(() => toast.classList.remove('show'), 3500);
}

async function loadQueue() {
  const res = await fetch('/api/cola/'+EVENTO_ID);
  const items = await res.json();
  const visible = items.filter(i => i.estado !== 'reproducida');
  const hash = JSON.stringify(visible.map(i=>({id:i.id,estado:i.estado,votos:i.votos})));
  if (hash === lastQueueHash) return;
  lastQueueHash = hash;

  const c = document.getElementById('queueContainer');
  const countEl = document.getElementById('queueCount');

  if (!visible.length) {
    countEl.style.display = 'none';
    c.innerHTML = `<div class="empty"><div class="empty-icon">üéµ</div><div class="empty-text" id="emptyText">${t[lang].noRequests}</div></div>`;
    return;
  }

  countEl.style.display = 'block';
  countEl.textContent = visible.length;

  c.innerHTML = visible.map(s => `
    <div class="queue-item ${s.id===mySongId?'my-song':''}">
      <img class="queue-img" src="${s.portada_url||''}" alt="" onerror="this.style.display='none'">
      <div style="flex:1;min-width:0">
        <div class="queue-name">${s.cancion}</div>
        <div class="queue-artist">${s.artista}</div>
        ${s.dedicatoria?`<div class="queue-dedic">üí¨ ${s.dedicatoria}</div>`:''}
        <div class="queue-meta">
          <span class="status-pill status-${s.estado}">${s.estado}</span>
          ${s.id===mySongId?`<span class="my-tag">${t[lang].yourSong}</span>`:''}
        </div>
      </div>
      <button class="vote-btn ${votados.includes(s.id)?'voted':''}" onclick="votar(${s.id},this)">üî•<br>${s.votos}</button>
    </div>`).join('');
}

async function votar(id, btn) {
  if (votados.includes(id)) { showToast(t[lang].toastAlready, true); return; }
  const res = await fetch('/api/votar/'+id, {method:'POST'});
  const data = await res.json();
  if (res.ok) {
    votados.push(id); localStorage.setItem('votados', JSON.stringify(votados));
    btn.classList.add('voted'); btn.innerHTML='üî•<br>'+data.votos;
    showToast(t[lang].toastVoted);
  }
}

function showRetryModal() {
  document.getElementById('retryModal').classList.add('show');
}

function retryRequest() {
  closeRetry();
  document.getElementById('searchInput').value = '';
  document.getElementById('results').innerHTML = '';
  document.getElementById('searchInput').focus();
  window.scrollTo({top:0, behavior:'smooth'});
}

function closeRetry() {
  document.getElementById('retryModal').classList.remove('show');
}

loadQueue();
setInterval(loadQueue, 10000);
</script>
</body>
</html>
