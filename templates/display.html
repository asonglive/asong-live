<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>asong.live ‚Äî Live Display</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --black:#0a0a0a; --white:#f5f5f0; --orange:#FF6B2B;
    --orange-dim:rgba(255,107,43,0.15); --gray:#1a1a1a;
    --gray-mid:#2a2a2a; --gray-text:#666;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--black); color:var(--white); font-family:'DM Sans',sans-serif; height:100vh; overflow:hidden; }
  body::before { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px); pointer-events:none; z-index:1000; }

  .display { display:grid; grid-template-rows:auto auto 1fr auto; height:100vh; padding:24px 48px 20px; gap:16px; }

  /* HEADER */
  .header { display:flex; align-items:center; justify-content:space-between; }
  .header-left { display:flex; flex-direction:column; gap:4px; }
  .logo { display:flex; align-items:center; gap:14px; }
  .logo-text { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:3px; color:var(--white); line-height:1; }
  .logo-text span { color:var(--orange); }
  .live-badge { display:flex; align-items:center; gap:8px; background:var(--orange-dim); border:1px solid var(--orange); border-radius:2px; padding:5px 12px; font-size:0.6rem; font-weight:700; letter-spacing:3px; text-transform:uppercase; color:var(--orange); }
  .live-dot { width:6px; height:6px; background:var(--orange); border-radius:50%; animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }
  .event-name { font-family:'Bebas Neue',sans-serif; font-size:2.4rem; letter-spacing:3px; color:var(--white); line-height:1; padding-left:38px; }
  .event-sub { font-size:0.65rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-text); padding-left:38px; }

  /* DJ MESSAGE - full width */
  .message-bar { background:var(--gray); border:1px solid var(--gray-mid); border-left:3px solid var(--orange); border-radius:4px; padding:14px 24px; display:flex; align-items:center; gap:16px; min-height:56px; }
  .message-label { font-size:0.55rem; letter-spacing:3px; text-transform:uppercase; color:var(--orange); white-space:nowrap; flex-shrink:0; }
  .message-text { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:2px; color:var(--white); line-height:1.2; flex:1; word-break:break-word; transition:color .3s; }
  .message-text.orange { color:var(--orange); }
  .message-text.empty { color:var(--gray-mid); font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:1px; }

  /* MAIN: queue + QR */
  .main { display:grid; grid-template-columns:1fr 320px; gap:24px; overflow:hidden; }

  /* SONG QUEUE */
  .queue-section { overflow:hidden; display:flex; flex-direction:column; gap:10px; }
  .section-label { font-size:0.6rem; letter-spacing:4px; text-transform:uppercase; color:var(--gray-text); display:flex; align-items:center; gap:12px; }
  .section-label::after { content:''; flex:1; height:1px; background:var(--gray-mid); }
  .queue-list { display:flex; flex-direction:column; gap:8px; overflow:hidden; }

  .song-card { display:flex; align-items:center; gap:14px; background:var(--gray); border:1px solid var(--gray-mid); border-radius:4px; padding:10px 16px; position:relative; overflow:hidden; }
  .song-card::before { content:''; position:absolute; left:0;top:0;bottom:0; width:3px; background:var(--gray-mid); }
  .song-card.aprobada::before { background:var(--orange); }
  .song-card.top { background:#1a1200; border-color:#3a2800; }
  .song-card.top::before { background:var(--orange); }
  .song-rank { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; color:var(--gray-text); min-width:36px; text-align:center; line-height:1; }
  .song-card.top .song-rank { color:var(--orange); }
  .song-cover { width:48px; height:48px; border-radius:3px; object-fit:cover; flex-shrink:0; background:var(--gray-mid); }
  .song-info { flex:1; min-width:0; }
  .song-title { font-weight:700; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .song-artist { font-size:0.75rem; color:var(--gray-text); margin-top:2px; }
  .song-dedic { font-size:0.68rem; color:var(--orange); margin-top:2px; font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .song-votes { display:flex; flex-direction:column; align-items:center; gap:1px; min-width:44px; }
  .votes-num { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; color:var(--white); line-height:1; }
  .song-card.top .votes-num { color:var(--orange); }
  .votes-label { font-size:0.5rem; letter-spacing:2px; text-transform:uppercase; color:var(--gray-text); }
  .status-badge { font-size:0.5rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; padding:3px 8px; border-radius:2px; background:var(--orange-dim); color:var(--orange); border:1px solid var(--orange); }

  .empty-queue { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; gap:12px; padding:32px; }
  .empty-queue-icon { font-family:'Bebas Neue',sans-serif; font-size:3rem; letter-spacing:4px; color:var(--gray-mid); }
  .empty-queue-text { font-size:0.7rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-mid); }

  /* QR + REDES panel derecho */
  .right-panel { display:flex; flex-direction:column; gap:12px; }
  .qr-box { background:var(--white); border-radius:8px; padding:16px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .qr-box img { width:220px; height:220px; display:block; }
  .qr-cta { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:var(--black); }
  .qr-url { font-size:0.6rem; letter-spacing:2px; text-transform:uppercase; color:#888; }

  /* SOCIAL MEDIA */
  .social-bar { background:var(--gray); border:1px solid var(--gray-mid); border-radius:4px; padding:12px 16px; display:flex; flex-direction:column; gap:8px; flex:1; }
  .social-title { font-size:0.55rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-text); margin-bottom:4px; }
  .social-link { display:flex; align-items:center; gap:10px; }
  .social-icon { font-size:1.2rem; width:28px; text-align:center; flex-shrink:0; }
  .social-handle { font-size:0.85rem; font-weight:600; color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .social-handle.empty { color:var(--gray-mid); font-size:0.7rem; font-weight:400; }
</style>
</head>
<body>
<div class="display">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 60" width="24" height="36">
          <rect x="0" y="15" width="5" height="30" fill="#FF6B2B" rx="2" opacity="0.4"/>
          <rect x="9" y="8" width="5" height="44" fill="#FF6B2B" rx="2" opacity="0.7"/>
          <rect x="18" y="0" width="5" height="60" fill="#FF6B2B" rx="2"/>
          <rect x="27" y="10" width="5" height="40" fill="#FF6B2B" rx="2" opacity="0.7"/>
          <rect x="36" y="20" width="5" height="20" fill="#FF6B2B" rx="2" opacity="0.4"/>
        </svg>
        <div class="logo-text">asong<span>.live</span></div>
        <div class="live-badge"><div class="live-dot"></div> Live</div>
      </div>
      <div class="event-name" id="eventName">DJ Request</div>
      <div class="event-sub" id="eventSub">DJ Request System</div>
    </div>
  </div>

  <!-- DJ MESSAGE - full width -->
  <div class="message-bar">
    <div class="message-label">üì¢ DJ</div>
    <div class="message-text empty" id="messageDisplay">Waiting for message...</div>
  </div>

  <!-- MAIN: queue izq + QR/redes der -->
  <div class="main">
    <div class="queue-section">
      <div class="section-label">Song Queue</div>
      <div class="queue-list" id="queueList">
        <div class="empty-queue">
          <div class="empty-queue-icon">‚ô™</div>
          <div class="empty-queue-text">Waiting for requests</div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <!-- QR GRANDE -->
      <div class="qr-box">
        <img src="/qr" alt="QR Code">
        <div class="qr-cta">Scan to Request</div>
        <div class="qr-url">www.asong.live</div>
      </div>
      <!-- REDES SOCIALES -->
      <div class="social-bar" id="socialBar" style="display:none">
        <div class="social-title">Follow the DJ</div>
        <div class="social-link" id="socialInstagram" style="display:none">
          <div class="social-icon">üì∏</div>
          <div class="social-handle" id="handleInstagram"></div>
        </div>
        <div class="social-link" id="socialTiktok" style="display:none">
          <div class="social-icon">üéµ</div>
          <div class="social-handle" id="handleTiktok"></div>
        </div>
        <div class="social-link" id="socialFacebook" style="display:none">
          <div class="social-icon">üë§</div>
          <div class="social-handle" id="handleFacebook"></div>
        </div>
        <div class="social-link" id="socialSpotify" style="display:none">
          <div class="social-icon">üéß</div>
          <div class="social-handle" id="handleSpotify"></div>
        </div>
        <div class="social-link" id="socialWebsite" style="display:none">
          <div class="social-icon">üåê</div>
          <div class="social-handle" id="handleWebsite"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS BAR -->
  <div style="display:flex;align-items:center;gap:32px;padding-top:12px;border-top:1px solid var(--gray-mid)">
    <div style="text-align:center"><div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--orange);line-height:1" id="statTotal">0</div><div style="font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--gray-text);margin-top:2px">Requests</div></div>
    <div style="width:1px;height:28px;background:var(--gray-mid)"></div>
    <div style="text-align:center"><div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--orange);line-height:1" id="statPending">0</div><div style="font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--gray-text);margin-top:2px">Pending</div></div>
    <div style="width:1px;height:28px;background:var(--gray-mid)"></div>
    <div style="text-align:center"><div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--orange);line-height:1" id="statApproved">0</div><div style="font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--gray-text);margin-top:2px">Approved</div></div>
    <div style="width:1px;height:28px;background:var(--gray-mid)"></div>
    <div style="text-align:center"><div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--orange);line-height:1" id="statVotes">0</div><div style="font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--gray-text);margin-top:2px">Votes</div></div>
    <div style="margin-left:auto;font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--gray-mid)">asong.live</div>
  </div>

</div>

<script>
const EVENTO_ID = {{ evento.id if evento else 1 }};
let lastQueueHash = '';

const protocol = location.protocol==='https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(protocol+'//'+location.host+'/ws/display');
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.tipo === 'dj_message') updateMessage(msg.texto, msg.color);
  else if (['nueva_solicitud','estado_actualizado','voto'].includes(msg.tipo)) loadQueue();
};
ws.onclose = () => setTimeout(() => location.reload(), 3000);

function updateMessage(texto, color) {
  const el = document.getElementById('messageDisplay');
  if (!texto) { el.textContent = 'Waiting for message...'; el.className = 'message-text empty'; }
  else { el.textContent = texto; el.className = 'message-text' + (color==='orange'?' orange':''); }
}

function showSocial(id, handle, handleElId) {
  if (handle) {
    document.getElementById(id).style.display = 'flex';
    document.getElementById(handleElId).textContent = handle;
    document.getElementById('socialBar').style.display = 'flex';
  }
}

async function loadConfig() {
  const res = await fetch('/api/config/publica');
  const cfg = await res.json();
  if (cfg.event_name) document.getElementById('eventName').textContent = cfg.event_name;
  if (cfg.subtitle) document.getElementById('eventSub').textContent = cfg.subtitle;
  showSocial('socialInstagram', cfg.instagram, 'handleInstagram');
  showSocial('socialTiktok', cfg.tiktok, 'handleTiktok');
  showSocial('socialFacebook', cfg.facebook, 'handleFacebook');
  showSocial('socialSpotify', cfg.spotify_dj, 'handleSpotify');
  showSocial('socialWebsite', cfg.website, 'handleWebsite');
}

async function loadQueue() {
  const res = await fetch('/api/cola/'+EVENTO_ID);
  const items = await res.json();
  const visible = items.filter(i => i.estado !== 'reproducida' && i.estado !== 'rechazada');
  const hash = JSON.stringify(visible.map(i=>({id:i.id,estado:i.estado,votos:i.votos})));
  if (hash === lastQueueHash) return;
  lastQueueHash = hash;

  document.getElementById('statTotal').textContent = items.length;
  document.getElementById('statPending').textContent = items.filter(i=>i.estado==='pendiente').length;
  document.getElementById('statApproved').textContent = items.filter(i=>i.estado==='aprobada').length;
  document.getElementById('statVotes').textContent = items.reduce((a,b)=>a+b.votos,0);

  const list = document.getElementById('queueList');
  if (!visible.length) {
    list.innerHTML = '<div class="empty-queue"><div class="empty-queue-icon">‚ô™</div><div class="empty-queue-text">Waiting for requests</div></div>';
    return;
  }

  const sorted = [...visible].sort((a,b) => {
    if (a.estado==='aprobada' && b.estado!=='aprobada') return -1;
    if (b.estado==='aprobada' && a.estado!=='aprobada') return 1;
    if (b.votos !== a.votos) return b.votos - a.votos;
    return a.id - b.id;
  });

  list.innerHTML = sorted.slice(0,6).map((s,i) => `
    <div class="song-card ${s.estado==='aprobada'?'aprobada':''} ${i===0?'top':''}">
      <div class="song-rank">${String(i+1).padStart(2,'0')}</div>
      <img class="song-cover" src="${s.portada_url||''}" alt="" onerror="this.style.display='none'">
      <div class="song-info">
        <div class="song-title">${s.cancion}</div>
        <div class="song-artist">${s.artista}</div>
        ${s.dedicatoria?`<div class="song-dedic">üí¨ ${s.dedicatoria}</div>`:''}
      </div>
      ${s.estado==='aprobada'?'<div class="status-badge">Next</div>':''}
      <div class="song-votes">
        <div class="votes-num">${s.votos}</div>
        <div class="votes-label">votes</div>
      </div>
    </div>`).join('');
}

loadConfig();
loadQueue();
setInterval(loadQueue, 10000);
</script>
</body>
</html>
