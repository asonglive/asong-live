<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>asong.live â€” Live Display</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --black:#0a0a0a; --white:#f5f5f0; --orange:#FF6B2B;
    --orange-dim:rgba(255,107,43,0.15); --gray:#1a1a1a;
    --gray-mid:#2a2a2a; --gray-text:#666;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--black); color:var(--white); font-family:'DM Sans',sans-serif; height:100vh; overflow:hidden; }
  body::before { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px); pointer-events:none; z-index:1000; }

  .display { display:grid; grid-template-rows:auto auto 1fr auto; height:100vh; padding:24px 48px 0; gap:16px; }

  /* HEADER */
  .header { display:flex; align-items:center; justify-content:space-between; }
  .header-left { display:flex; flex-direction:column; gap:4px; }
  .logo { display:flex; align-items:center; gap:14px; }
  .logo-text { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:3px; color:var(--white); line-height:1; }
  .logo-text span { color:var(--orange); }
  .live-badge { display:flex; align-items:center; gap:8px; background:var(--orange-dim); border:1px solid var(--orange); border-radius:2px; padding:5px 12px; font-size:0.6rem; font-weight:700; letter-spacing:3px; text-transform:uppercase; color:var(--orange); }
  .live-dot { width:6px; height:6px; background:var(--orange); border-radius:50%; animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }
  .event-name { font-family:'Bebas Neue',sans-serif; font-size:2.4rem; letter-spacing:3px; color:var(--white); line-height:1; padding-left:38px; }
  .event-sub { font-size:0.65rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-text); padding-left:38px; }

  /* DJ MESSAGE - full width */
  .message-bar { background:var(--gray); border:1px solid var(--gray-mid); border-left:3px solid var(--orange); border-radius:4px; padding:14px 24px; overflow:hidden; min-height:56px; display:flex; align-items:center; }
  .message-scroll { white-space:nowrap; font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:2px; color:var(--white); line-height:1.2; transition:color .3s; display:inline-block; }
  .message-scroll.orange { color:var(--orange); }
  .message-scroll.empty { color:var(--gray-mid); font-size:1rem; font-family:'DM Sans',sans-serif; font-weight:400; letter-spacing:1px; white-space:nowrap; }
  @keyframes ticker { 0% { transform:translateX(100%); } 100% { transform:translateX(-100%); } }
  .message-scroll.scrolling { animation:ticker 18s linear infinite; }

  /* MAIN: queue + QR */
  .main { display:grid; grid-template-columns:1fr 320px; gap:24px; overflow:hidden; }

  /* SONG QUEUE */
  .queue-section { overflow:hidden; display:flex; flex-direction:column; gap:10px; }
  .section-label { font-size:0.6rem; letter-spacing:4px; text-transform:uppercase; color:var(--gray-text); display:flex; align-items:center; gap:12px; }
  .section-label::after { content:''; flex:1; height:1px; background:var(--gray-mid); }
  .queue-list { display:flex; flex-direction:column; gap:8px; overflow:hidden; }

  .song-card { display:flex; align-items:center; gap:14px; background:var(--gray); border:1px solid var(--gray-mid); border-radius:4px; padding:10px 16px; position:relative; overflow:hidden; }
  .song-card::before { content:''; position:absolute; left:0;top:0;bottom:0; width:3px; background:var(--gray-mid); }
  .song-card.aprobada::before { background:var(--orange); }
  .song-card.top { background:#1a1200; border-color:#3a2800; }
  .song-card.top::before { background:var(--orange); }
  .song-rank { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; color:var(--gray-text); min-width:36px; text-align:center; line-height:1; }
  .song-card.top .song-rank { color:var(--orange); }
  .song-cover { width:48px; height:48px; border-radius:3px; object-fit:cover; flex-shrink:0; background:var(--gray-mid); }
  .song-info { flex:1; min-width:0; }
  .song-title { font-weight:700; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .song-artist { font-size:0.75rem; color:var(--gray-text); margin-top:2px; }
  .song-dedic { font-size:0.68rem; color:var(--orange); margin-top:2px; font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .song-votes { display:flex; flex-direction:column; align-items:center; gap:1px; min-width:44px; }
  .votes-num { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; color:var(--white); line-height:1; }
  .song-card.top .votes-num { color:var(--orange); }
  .votes-label { font-size:0.5rem; letter-spacing:2px; text-transform:uppercase; color:var(--gray-text); }
  .status-badge { font-size:0.5rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; padding:3px 8px; border-radius:2px; background:var(--orange-dim); color:var(--orange); border:1px solid var(--orange); }

  .empty-queue { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; gap:12px; padding:32px; }
  .empty-queue-icon { font-family:'Bebas Neue',sans-serif; font-size:3rem; letter-spacing:4px; color:var(--gray-mid); }
  .empty-queue-text { font-size:0.7rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-mid); }

  /* QR + REDES panel derecho */
  .right-panel { display:flex; flex-direction:column; gap:12px; }
  .qr-box { background:var(--white); border-radius:8px; padding:16px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .qr-box img { width:220px; height:220px; display:block; }
  .qr-cta { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; color:var(--black); }
  .qr-url { font-size:0.6rem; letter-spacing:2px; text-transform:uppercase; color:#888; }

  /* SOCIAL MEDIA */
  .social-bar { background:var(--gray); border:1px solid var(--gray-mid); border-radius:4px; padding:16px; display:flex; flex-direction:column; gap:14px; flex:1; justify-content:center; }
  .social-title { font-size:0.55rem; letter-spacing:3px; text-transform:uppercase; color:var(--gray-text); margin-bottom:2px; }
  .social-link { display:flex; align-items:center; gap:14px; }
  .social-icon-wrap { width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .social-handle { font-size:1rem; font-weight:700; color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:0.5px; }
</style>
</head>
<body>
<div class="display">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 60" width="24" height="36">
          <rect x="0" y="15" width="5" height="30" fill="#FF6B2B" rx="2" opacity="0.4"/>
          <rect x="9" y="8" width="5" height="44" fill="#FF6B2B" rx="2" opacity="0.7"/>
          <rect x="18" y="0" width="5" height="60" fill="#FF6B2B" rx="2"/>
          <rect x="27" y="10" width="5" height="40" fill="#FF6B2B" rx="2" opacity="0.7"/>
          <rect x="36" y="20" width="5" height="20" fill="#FF6B2B" rx="2" opacity="0.4"/>
        </svg>
        <div class="logo-text">asong<span>.live</span></div>
        <div class="live-badge"><div class="live-dot"></div> Live</div>
      </div>
      <div class="event-name" id="eventName">DJ Request</div>
      <div class="event-sub" id="eventSub">DJ Request System</div>
    </div>
  </div>

  <!-- DJ MESSAGE - full width -->
  <div class="message-bar">
    <div class="message-scroll empty" id="messageDisplay">Waiting for message...</div>
  </div>

  <!-- MAIN: queue izq + QR/redes der -->
  <div class="main">
    <div class="queue-section">
      <div class="section-label">Song Queue</div>
      <div class="queue-list" id="queueList">
        <div class="empty-queue">
          <div class="empty-queue-icon">â™ª</div>
          <div class="empty-queue-text">Waiting for requests</div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <!-- QR GRANDE -->
      <div class="qr-box">
        <img src="/qr" alt="QR Code">
        <div class="qr-cta">Scan to Request</div>
        <div class="qr-url">www.asong.live</div>
      </div>

    </div>
  </div>

  <!-- FOOTER REDES SOCIALES -->
  <div id="socialFooter" style="border-top:1px solid var(--gray-mid);padding:14px 0;display:none">
    <div style="display:flex;align-items:center;justify-content:center;gap:40px;flex-wrap:wrap">
      <div id="footerInstagram" style="display:none;flex-direction:column;align-items:center;gap:6px">
        <div style="width:48px;height:48px;border-radius:14px;background:radial-gradient(circle at 30% 107%,#fdf497 0%,#fdf497 5%,#fd5949 45%,#d6249f 60%,#285AEB 90%);display:flex;align-items:center;justify-content:center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        </div>
        <div id="footerHandleInstagram" style="font-size:0.75rem;font-weight:700;color:var(--white);letter-spacing:0.5px"></div>
      </div>
      <div id="footerTiktok" style="display:none;flex-direction:column;align-items:center;gap:6px">
        <div style="width:48px;height:48px;border-radius:14px;background:#000;border:1px solid #333;display:flex;align-items:center;justify-content:center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.69a8.18 8.18 0 004.78 1.52V6.75a4.85 4.85 0 01-1.01-.06z"/></svg>
        </div>
        <div id="footerHandleTiktok" style="font-size:0.75rem;font-weight:700;color:var(--white);letter-spacing:0.5px"></div>
      </div>
      <div id="footerFacebook" style="display:none;flex-direction:column;align-items:center;gap:6px">
        <div style="width:48px;height:48px;border-radius:14px;background:#1877F2;display:flex;align-items:center;justify-content:center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
        </div>
        <div id="footerHandleFacebook" style="font-size:0.75rem;font-weight:700;color:var(--white);letter-spacing:0.5px"></div>
      </div>
      <div id="footerSpotify" style="display:none;flex-direction:column;align-items:center;gap:6px">
        <div style="width:48px;height:48px;border-radius:14px;background:#1DB954;display:flex;align-items:center;justify-content:center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        </div>
        <div id="footerHandleSpotify" style="font-size:0.75rem;font-weight:700;color:var(--white);letter-spacing:0.5px"></div>
      </div>
      <div id="footerWebsite" style="display:none;flex-direction:column;align-items:center;gap:6px">
        <div style="width:48px;height:48px;border-radius:14px;background:#333;border:1px solid #555;display:flex;align-items:center;justify-content:center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
        <div id="footerHandleWebsite" style="font-size:0.75rem;font-weight:700;color:var(--white);letter-spacing:0.5px"></div>
      </div>
      <div style="margin-left:auto;font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--gray-mid)">asong.live</div>
    </div>
  </div>

</div>

<script>
const EVENTO_ID = {{ evento.id if evento else 1 }};
let lastQueueHash = '';

const protocol = location.protocol==='https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(protocol+'//'+location.host+'/ws/display');
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.tipo === 'dj_message') updateMessage(msg.texto, msg.color);
  else if (['nueva_solicitud','estado_actualizado','voto'].includes(msg.tipo)) loadQueue();
};
ws.onclose = () => setTimeout(() => location.reload(), 3000);

function updateMessage(texto, color) {
  const el = document.getElementById('messageDisplay');
  if (!texto) {
    el.textContent = 'Waiting for message...';
    el.className = 'message-scroll empty';
    el.style.animation = 'none';
    el.style.transform = '';
  } else {
    el.textContent = texto;
    el.className = 'message-scroll' + (color==='orange'?' orange':'');
    // Scroll solo si el texto es largo
    const bar = el.parentElement;
    if (el.scrollWidth > bar.clientWidth * 0.8) {
      el.classList.add('scrolling');
    } else {
      el.classList.remove('scrolling');
      el.style.animation = 'none';
    }
  }
}

function showFooterSocial(footerId, handle, handleElId) {
  if (handle) {
    const el = document.getElementById(footerId);
    if (el) { el.style.display = 'flex'; }
    const handleEl = document.getElementById(handleElId);
    if (handleEl) handleEl.textContent = handle;
    document.getElementById('socialFooter').style.display = 'block';
  }
}

async function loadConfig() {
  const res = await fetch('/api/config/publica');
  const cfg = await res.json();
  if (cfg.event_name) document.getElementById('eventName').textContent = cfg.event_name;
  if (cfg.subtitle) document.getElementById('eventSub').textContent = cfg.subtitle;
  showFooterSocial('footerInstagram', cfg.instagram, 'footerHandleInstagram');
  showFooterSocial('footerTiktok', cfg.tiktok, 'footerHandleTiktok');
  showFooterSocial('footerFacebook', cfg.facebook, 'footerHandleFacebook');
  showFooterSocial('footerSpotify', cfg.spotify_dj, 'footerHandleSpotify');
  showFooterSocial('footerWebsite', cfg.website, 'footerHandleWebsite');
}

async function loadQueue() {
  const res = await fetch('/api/cola/'+EVENTO_ID);
  const items = await res.json();
  const visible = items.filter(i => i.estado !== 'reproducida' && i.estado !== 'rechazada');
  const hash = JSON.stringify(visible.map(i=>({id:i.id,estado:i.estado,votos:i.votos})));
  if (hash === lastQueueHash) return;
  lastQueueHash = hash;

  const _st=document.getElementById('statTotal'); if(_st) _st.textContent = items.length;
  const _sp=document.getElementById('statPending'); if(_sp) _sp.textContent = items.filter(i=>i.estado==='pendiente').length;
  const _sa=document.getElementById('statApproved'); if(_sa) _sa.textContent = items.filter(i=>i.estado==='aprobada').length;
  const _sv=document.getElementById('statVotes'); if(_sv) _sv.textContent = items.reduce((a,b)=>a+b.votos,0);

  const list = document.getElementById('queueList');
  if (!visible.length) {
    list.innerHTML = '<div class="empty-queue"><div class="empty-queue-icon">â™ª</div><div class="empty-queue-text">Waiting for requests</div></div>';
    return;
  }

  const sorted = [...visible].sort((a,b) => {
    if (a.estado==='aprobada' && b.estado!=='aprobada') return -1;
    if (b.estado==='aprobada' && a.estado!=='aprobada') return 1;
    if (b.votos !== a.votos) return b.votos - a.votos;
    return a.id - b.id;
  });

  list.innerHTML = sorted.slice(0,6).map((s,i) => `
    <div class="song-card ${s.estado==='aprobada'?'aprobada':''} ${i===0?'top':''}">
      <div class="song-rank">${String(i+1).padStart(2,'0')}</div>
      <img class="song-cover" src="${s.portada_url||''}" alt="" onerror="this.style.display='none'">
      <div class="song-info">
        <div class="song-title">${s.cancion}</div>
        <div class="song-artist">${s.artista}</div>
        ${s.dedicatoria?`<div class="song-dedic">ðŸ’¬ ${s.dedicatoria}</div>`:''}
      </div>
      ${s.estado==='aprobada'?'<div class="status-badge">Next</div>':''}
      <div class="song-votes">
        <div class="votes-num">${s.votos}</div>
        <div class="votes-label">votes</div>
      </div>
    </div>`).join('');
}

loadConfig();
loadQueue();
setInterval(loadQueue, 10000);
</script>
</body>
</html>
